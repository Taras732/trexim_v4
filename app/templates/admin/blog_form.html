{% extends "admin/base.html" %}

{% block title %}{% if action == 'create' %}–ù–æ–≤–∞ —Å—Ç–∞—Ç—Ç—è{% else %}–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Å—Ç–∞—Ç—Ç—ñ{% endif %} - Trexim Admin{% endblock %}
{% block page_title %}{% if action == 'create' %}–ù–æ–≤–∞ —Å—Ç–∞—Ç—Ç—è{% else %}–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Å—Ç–∞—Ç—Ç—ñ{% endif %}{% endblock %}

{% block content %}
<div x-data="blogForm()" @submit="isSubmitting = true" class="max-w-5xl">
    <div class="mb-6 flex items-center space-x-4">
        <a href="/admin/blog" class="text-gray-600 hover:text-orange-500">&larr; –ù–∞–∑–∞–¥</a>
    </div>

    {% if error %}
    <div class="mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
        {{ error }}
    </div>
    {% endif %}

    <form method="POST" action="{% if action == 'create' %}/admin/blog{% else %}/admin/blog/{{ slug }}/update{% endif %}"
          enctype="multipart/form-data" class="space-y-6">

        <!-- Basic Info Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold mb-4 pb-2 border-b">–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                {% if action == 'create' %}
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Slug (URL)</label>
                    <input type="text" name="slug" value="" placeholder="auto-generated-from-title"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm">
                    <p class="text-xs text-gray-500 mt-1">–ó–∞–ª–∏—à—Ç–µ –ø–æ—Ä–æ–∂–Ω—ñ–º –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∑ –Ω–∞–∑–≤–∏</p>
                </div>
                {% endif %}

                <!-- Image or Emoji Selection -->
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç—Ç—ñ</label>

                    <div class="flex gap-4 mb-3">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="visual_type" value="emoji" x-model="visualType" class="mr-2">
                            <span class="text-sm">Emoji</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="visual_type" value="image" x-model="visualType" class="mr-2">
                            <span class="text-sm">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è</span>
                        </label>
                    </div>

                    <!-- Emoji Picker -->
                    <div x-show="visualType === 'emoji'" x-cloak class="flex items-center gap-3">
                        <input type="text" name="emoji" x-model="emoji"
                               class="w-20 px-4 py-2 border border-gray-300 rounded-lg text-2xl text-center focus:ring-2 focus:ring-orange-500">
                        <div class="flex flex-wrap gap-2">
                            <template x-for="e in popularEmojis" :key="e">
                                <button type="button" @click="emoji = e"
                                        class="w-10 h-10 text-xl hover:bg-gray-100 rounded-lg transition"
                                        x-text="e"></button>
                            </template>
                        </div>
                    </div>

                    <!-- Image Upload with Preview -->
                    <div x-show="visualType === 'image'" x-cloak class="space-y-3">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-orange-500 transition">
                            <input type="file" name="cover_image" id="cover_image" accept="image/*" @change="previewImage($event)"
                                   class="hidden">
                            <label for="cover_image" class="cursor-pointer">
                                <div class="text-4xl mb-2">üì∑</div>
                                <p class="text-sm text-gray-600">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</p>
                                <p class="text-xs text-gray-400 mt-1">PNG, JPG, WebP –¥–æ 10MB</p>
                            </label>
                        </div>

                        <!-- Preview -->
                        <div x-show="imagePreview" x-cloak class="mt-3">
                            <p class="text-sm text-gray-600 mb-2">–ü—Ä–µ–≤—å—é:</p>
                            <img :src="imagePreview" class="max-w-xs max-h-48 rounded-lg border border-gray-200 shadow-sm">
                        </div>

                        <!-- Current Image (for edit mode) -->
                        {% if post and post.uk.image %}
                        <div class="mt-2">
                            <p class="text-sm text-gray-600 mb-2">–ü–æ—Ç–æ—á–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:</p>
                            <img src="{{ post.uk.image }}" class="max-w-xs max-h-48 rounded-lg border border-gray-200 shadow-sm">
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Color -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ö–æ–ª—ñ—Ä</label>
                    <select name="color" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <option value="orange" {% if post and post.uk.color == 'orange' %}selected{% endif %}>Orange</option>
                        <option value="blue" {% if post and post.uk.color == 'blue' %}selected{% endif %}>Blue</option>
                        <option value="green" {% if post and post.uk.color == 'green' %}selected{% endif %}>Green</option>
                        <option value="purple" {% if post and post.uk.color == 'purple' %}selected{% endif %}>Purple</option>
                        <option value="red" {% if post and post.uk.color == 'red' %}selected{% endif %}>Red</option>
                        <option value="yellow" {% if post and post.uk.color == 'yellow' %}selected{% endif %}>Yellow</option>
                    </select>
                </div>

                <!-- Category -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                    <select name="category_code" x-model="categoryCode" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é...</option>
                        {% for cat in categories %}
                        <option value="{{ cat.code }}"
                                data-uk="{{ cat.name_uk }}"
                                data-en="{{ cat.name_en }}"
                                {% if post and post.uk.category == cat.name_uk %}selected{% endif %}>
                            {{ cat.name_uk }} / {{ cat.name_en }}
                        </option>
                        {% endfor %}
                    </select>
                    <!-- Hidden fields for category names -->
                    <input type="hidden" name="category_uk" :value="getCategoryName('uk')">
                    <input type="hidden" name="category_en" :value="getCategoryName('en')">
                </div>

                <!-- Read Time -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ß–∞—Å —á–∏—Ç–∞–Ω–Ω—è (—Ö–≤)</label>
                    <input type="number" name="read_time" value="{{ post.uk.read_time if post else '5' }}" min="1" max="60" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>

                <!-- Tags Multi-select -->
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">–¢–µ–≥–∏</label>
                    <div class="flex flex-wrap gap-2 p-3 border border-gray-300 rounded-lg min-h-[44px] bg-white">
                        {% for tag in tags %}
                        <label class="inline-flex items-center px-3 py-1 rounded-full text-sm cursor-pointer transition"
                               :class="selectedTags.includes('{{ tag.code }}') ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'">
                            <input type="checkbox" name="tag_codes" value="{{ tag.code }}"
                                   x-model="selectedTags" class="sr-only">
                            <span>{{ tag.name_uk }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <!-- Hidden fields for tag names -->
                    <input type="hidden" name="tags_uk" :value="getTagNames('uk')">
                    <input type="hidden" name="tags_en" :value="getTagNames('en')">
                </div>

                <!-- Publication Date/Time -->
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–î–∞—Ç–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó</label>
                    <div class="flex flex-wrap items-center gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="publish_type" value="now" x-model="publishType" class="mr-2">
                            <span class="text-sm">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –∑–∞—Ä–∞–∑</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="publish_type" value="schedule" x-model="publishType" class="mr-2">
                            <span class="text-sm">–ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏</span>
                        </label>

                        <div x-show="publishType === 'schedule'" class="flex gap-2">
                            <input type="date" name="publish_date" x-model="publishDate"
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500">
                            <input type="time" name="publish_time" x-model="publishTime"
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>
                    <!-- Hidden formatted date fields -->
                    <input type="hidden" name="date_uk" :value="getFormattedDate('uk')">
                    <input type="hidden" name="date_en" :value="getFormattedDate('en')">
                </div>

                <!-- Show on Homepage -->
                <div class="md:col-span-3">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" name="show_on_homepage" value="true" x-model="showOnHomepage"
                               class="w-5 h-5 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                        <span class="text-sm font-medium text-gray-700">–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-8">–°—Ç–∞—Ç—Ç—è –±—É–¥–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏—Å—å —É —Å–µ–∫—Ü—ñ—ó –±–ª–æ–≥—É –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π</p>
                </div>
            </div>
        </div>

        <!-- Ukrainian Content -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold mb-4 pb-2 border-b flex items-center gap-2">
                <span class="text-xl">üá∫üá¶</span> –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –≤–µ—Ä—Å—ñ—è
            </h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" name="title_uk" value="{{ post.uk.title if post else '' }}" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å</label>
                    <textarea name="excerpt_uk" rows="2" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">{{ post.uk.excerpt if post else '' }}</textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ö–æ–Ω—Ç–µ–Ω—Ç (Markdown)</label>
                    <textarea name="content_uk" rows="15" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 font-mono text-sm">{{ post.uk.content if post else '' }}</textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        Markdown: # –ó–∞–≥–æ–ª–æ–≤–æ–∫, ## –ü—ñ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫, **–∂–∏—Ä–Ω–∏–π**, *–∫—É—Ä—Å–∏–≤*, [–ø–æ—Å–∏–ª–∞–Ω–Ω—è](url), - —Å–ø–∏—Å–æ–∫
                    </p>
                </div>
            </div>
        </div>

        <!-- English Content -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4 pb-2 border-b">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <span class="text-xl">üá¨üáß</span> English version
                </h2>
                <button type="button" @click="autoTranslate()"
                        class="text-sm text-orange-600 hover:text-orange-700 font-medium">
                    –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª–∞–¥ –∑ UK
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" name="title_en" x-model="titleEn" value="{{ post.en.title if post else '' }}" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Excerpt</label>
                    <textarea name="excerpt_en" x-model="excerptEn" rows="2" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">{{ post.en.excerpt if post else '' }}</textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Content (Markdown)</label>
                    <textarea name="content_en" x-model="contentEn" rows="15" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 font-mono text-sm">{{ post.en.content if post else '' }}</textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        Markdown: # Heading, ## Subheading, **bold**, *italic*, [link](url), - list
                    </p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-between items-center pt-4">
            <a href="/admin/blog" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                –°–∫–∞—Å—É–≤–∞—Ç–∏
            </a>
            <div class="flex gap-3">
                <button type="submit" name="status" value="draft" :disabled="isSubmitting"
                        class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium disabled:opacity-50">
                    –ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ —á–µ—Ä–Ω–µ—Ç–∫—É
                </button>
                <button type="submit" name="status" value="published" :disabled="isSubmitting"
                        class="px-8 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition font-medium disabled:opacity-50 flex items-center gap-2">
                    <span x-show="isSubmitting" class="animate-spin">‚è≥</span>
                    <span x-text="isSubmitting ? '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...' : '{% if action == 'create' %}–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏{% else %}–ó–±–µ—Ä–µ–≥—Ç–∏{% endif %}'"></span>
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function blogForm() {
    // Tag data from server
    const tagData = {
        {% for tag in tags %}
        '{{ tag.code }}': { uk: '{{ tag.name_uk }}', en: '{{ tag.name_en }}' },
        {% endfor %}
    };

    // Category data from server
    const categoryData = {
        {% for cat in categories %}
        '{{ cat.code }}': { uk: '{{ cat.name_uk }}', en: '{{ cat.name_en }}' },
        {% endfor %}
    };

    return {
        isSubmitting: false,
        visualType: '{{ "image" if post and post.uk.image else "emoji" }}',
        emoji: '{{ post.uk.emoji if post else "üìã" }}',
        popularEmojis: ['üìã', 'üöö', 'üì¶', 'ü§ñ', 'üìä', 'üîß', 'üí°', 'üåç', 'üìà', 'üõ£Ô∏è', '‚ö°', 'üéØ'],
        imagePreview: null,

        previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π. –ú–∞–∫—Å–∏–º—É–º 10MB.');
                    event.target.value = '';
                    this.imagePreview = null;
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.imagePreview = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        },

        categoryCode: '{% for cat in categories %}{% if post and post.uk.category == cat.name_uk %}{{ cat.code }}{% endif %}{% endfor %}',

        selectedTags: [{% if post and post.uk.tags %}{% for tag in tags %}{% if tag.name_uk in post.uk.tags %}'{{ tag.code }}',{% endif %}{% endfor %}{% endif %}],

        publishType: 'now',
        publishDate: new Date().toISOString().split('T')[0],
        publishTime: '09:00',
        showOnHomepage: {{ 'true' if post and post.show_on_homepage else 'false' }},

        titleEn: {{ (post.en.title | tojson) if post and post.en.title else '""' }},
        excerptEn: {{ (post.en.excerpt | tojson) if post and post.en.excerpt else '""' }},
        contentEn: {{ (post.en.content | tojson) if post and post.en.content else '""' }},

        getCategoryName(lang) {
            if (!this.categoryCode) return '';
            return categoryData[this.categoryCode]?.[lang] || '';
        },

        getTagNames(lang) {
            return this.selectedTags
                .map(code => tagData[code]?.[lang] || code)
                .join(', ');
        },

        getFormattedDate(lang) {
            const date = this.publishType === 'now' ? new Date() : new Date(this.publishDate + 'T' + this.publishTime);

            if (lang === 'uk') {
                const months = ['—Å—ñ—á–Ω—è', '–ª—é—Ç–æ–≥–æ', '–±–µ—Ä–µ–∑–Ω—è', '–∫–≤—ñ—Ç–Ω—è', '—Ç—Ä–∞–≤–Ω—è', '—á–µ—Ä–≤–Ω—è',
                               '–ª–∏–ø–Ω—è', '—Å–µ—Ä–ø–Ω—è', '–≤–µ—Ä–µ—Å–Ω—è', '–∂–æ–≤—Ç–Ω—è', '–ª–∏—Å—Ç–æ–ø–∞–¥–∞', '–≥—Ä—É–¥–Ω—è'];
                return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
            } else {
                const months = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
                return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
            }
        },

        async autoTranslate() {
            const titleUk = document.querySelector('[name="title_uk"]').value;
            const excerptUk = document.querySelector('[name="excerpt_uk"]').value;
            const contentUk = document.querySelector('[name="content_uk"]').value;

            if (!titleUk) {
                alert('–°–ø–æ—á–∞—Ç–∫—É –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –≤–µ—Ä—Å—ñ—é');
                return;
            }

            // Simple placeholder - in real app would call translation API
            this.titleEn = titleUk + ' [EN]';
            this.excerptEn = excerptUk + ' [EN]';
            this.contentEn = contentUk;

            alert('–ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª–∞–¥ –ø–æ—Ç—Ä–µ–±—É—î —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ API –ø–µ—Ä–µ–∫–ª–∞–¥—É (Google Translate, DeepL —Ç–æ—â–æ). –ü–æ–∫–∏ —â–æ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π —Ç–µ–∫—Å—Ç.');
        }
    }
}
</script>
{% endblock %}
