{% extends "admin/base.html" %}

{% block title %}{% if action == 'create' %}Нова стаття{% else %}Редагування статті{% endif %} - Trexim Admin{% endblock %}
{% block page_title %}{% if action == 'create' %}Нова стаття{% else %}Редагування статті{% endif %}{% endblock %}

{% block content %}
<div class="max-w-5xl">
    <div class="mb-6 flex items-center space-x-4">
        <a href="/admin/blog" class="text-gray-600 hover:text-orange-500">&larr; Назад до списку</a>
    </div>

    {% if error %}
    <div class="mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
        {{ error }}
    </div>
    {% endif %}

    <form id="blogForm" method="POST"
          action="{% if action == 'create' %}/admin/blog{% else %}/admin/blog/{{ slug }}/update{% endif %}"
          enctype="multipart/form-data" class="space-y-6">

        <!-- Basic Info Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold mb-4 pb-2 border-b">Основна інформація</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                {% if action == 'create' %}
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Slug (URL)</label>
                    <input type="text" name="slug" value="" placeholder="auto-generated-from-title"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-mono text-sm">
                    <p class="text-xs text-gray-500 mt-1">Залиште порожнім для автогенерації з назви</p>
                </div>
                {% endif %}

                <!-- Emoji -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Emoji</label>
                    <input type="text" name="emoji" value="{{ post.uk.emoji if post else '' }}"
                           class="w-20 px-4 py-2 border border-gray-300 rounded-lg text-2xl text-center focus:ring-2 focus:ring-orange-500">
                    <p class="text-xs text-gray-500 mt-1">Використовується якщо немає фото</p>
                </div>

                <!-- Cover Image -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Обкладинка (опційно)</label>
                    <input type="file" name="cover_image" accept="image/*"
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100 cursor-pointer">
                    {% if post and post.uk.image %}
                    <div class="mt-2">
                        <p class="text-xs text-gray-500">Поточне зображення:</p>
                        <img src="{{ post.uk.image }}" class="max-w-xs max-h-24 rounded-lg border mt-1">
                    </div>
                    {% endif %}
                </div>

                <!-- Color -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Колір</label>
                    <select name="color" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <option value="orange" {% if post and post.uk.color == 'orange' %}selected{% endif %}>Orange</option>
                        <option value="blue" {% if post and post.uk.color == 'blue' %}selected{% endif %}>Blue</option>
                        <option value="green" {% if post and post.uk.color == 'green' %}selected{% endif %}>Green</option>
                        <option value="purple" {% if post and post.uk.color == 'purple' %}selected{% endif %}>Purple</option>
                        <option value="red" {% if post and post.uk.color == 'red' %}selected{% endif %}>Red</option>
                        <option value="yellow" {% if post and post.uk.color == 'yellow' %}selected{% endif %}>Yellow</option>
                    </select>
                </div>

                <!-- Category -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Категорія</label>
                    <select id="categorySelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" required>
                        <option value="">Оберіть категорію...</option>
                        {% for cat in categories %}
                        <option value="{{ cat.code }}"
                                data-uk="{{ cat.name_uk }}"
                                data-en="{{ cat.name_en }}"
                                {% if post and post.uk.category == cat.name_uk %}selected{% endif %}>
                            {{ cat.name_uk }} / {{ cat.name_en }}
                        </option>
                        {% endfor %}
                    </select>
                    <!-- Hidden fields for actual form submission -->
                    <input type="hidden" name="category_uk" id="category_uk" value="{{ post.uk.category if post else '' }}">
                    <input type="hidden" name="category_en" id="category_en" value="{{ post.en.category if post else '' }}">
                </div>

                <!-- Read Time -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Час читання (хв)</label>
                    <input type="number" name="read_time" value="{{ post.uk.read_time if post else '5' }}" min="1" max="60" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>

                <!-- Tags -->
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Теги</label>
                    <div class="flex flex-wrap gap-2 p-3 border border-gray-300 rounded-lg bg-white">
                        {% for tag in tags %}
                        <label class="tag-label inline-flex items-center px-3 py-1 rounded-full text-sm cursor-pointer transition bg-gray-100 text-gray-700 hover:bg-gray-200">
                            <input type="checkbox" class="tag-checkbox sr-only"
                                   data-uk="{{ tag.name_uk }}"
                                   data-en="{{ tag.name_en }}"
                                   {% if post and tag.name_uk in post.uk.tags %}checked{% endif %}>
                            <span>{{ tag.name_uk }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="tags_uk" id="tags_uk" value="{{ post.uk.tags | join(', ') if post and post.uk.tags else '' }}">
                    <input type="hidden" name="tags_en" id="tags_en" value="{{ post.en.tags | join(', ') if post and post.en.tags else '' }}">
                </div>

                <!-- Publication Date -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Дата публікації</label>
                    <input type="date" id="publishDate"
                           value="{{ post.uk.date if post else '' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    <p class="text-xs text-gray-500 mt-1">Залиште порожнім для поточної дати</p>
                    <input type="hidden" name="date_uk" id="date_uk" value="{{ post.uk.date if post else '' }}">
                    <input type="hidden" name="date_en" id="date_en" value="{{ post.en.date if post else '' }}">
                </div>

                <!-- Show on Homepage -->
                <div class="md:col-span-3">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" name="show_on_homepage" value="true"
                               {% if post and post.show_on_homepage %}checked{% endif %}
                               class="w-5 h-5 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                        <span class="text-sm font-medium text-gray-700">Показувати на головній сторінці</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-8">Стаття буде відображатись у секції блогу на головній</p>
                </div>
            </div>
        </div>

        <!-- Ukrainian Content -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold mb-4 pb-2 border-b flex items-center gap-2">
                <span class="text-xl">&#127482;&#127462;</span> Українська версія
            </h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Заголовок *</label>
                    <input type="text" name="title_uk" id="title_uk" value="{{ post.uk.title if post else '' }}" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Короткий опис *</label>
                    <textarea name="excerpt_uk" rows="2" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">{{ post.uk.excerpt if post else '' }}</textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Контент (Markdown) *</label>
                    <textarea name="content_uk" rows="15" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 font-mono text-sm">{{ post.uk.content if post else '' }}</textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        Markdown: # Заголовок, ## Підзаголовок, **жирний**, *курсив*, [посилання](url), - список
                    </p>
                </div>
            </div>
        </div>

        <!-- English Content -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold mb-4 pb-2 border-b flex items-center gap-2">
                <span class="text-xl">&#127468;&#127463;</span> English version
            </h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                    <input type="text" name="title_en" value="{{ post.en.title if post else '' }}" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Excerpt *</label>
                    <textarea name="excerpt_en" rows="2" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">{{ post.en.excerpt if post else '' }}</textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Content (Markdown) *</label>
                    <textarea name="content_en" rows="15" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 font-mono text-sm">{{ post.en.content if post else '' }}</textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        Markdown: # Heading, ## Subheading, **bold**, *italic*, [link](url), - list
                    </p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-between items-center pt-4">
            <a href="/admin/blog" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                Скасувати
            </a>
            <button type="submit" id="submitBtn"
                    class="px-8 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition font-medium">
                {% if action == 'create' %}Створити статтю{% else %}Зберегти зміни{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('blogForm');
    const categorySelect = document.getElementById('categorySelect');
    const tagCheckboxes = document.querySelectorAll('.tag-checkbox');
    const tagLabels = document.querySelectorAll('.tag-label');

    // Update tag visual state
    function updateTagStyles() {
        tagCheckboxes.forEach((checkbox, index) => {
            const label = tagLabels[index];
            if (checkbox.checked) {
                label.classList.remove('bg-gray-100', 'text-gray-700');
                label.classList.add('bg-orange-500', 'text-white');
            } else {
                label.classList.remove('bg-orange-500', 'text-white');
                label.classList.add('bg-gray-100', 'text-gray-700');
            }
        });
    }

    // Initialize tag styles
    updateTagStyles();

    // Toggle tag on click
    tagCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateTagStyles);
    });

    // Update category hidden fields when selection changes
    categorySelect.addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        document.getElementById('category_uk').value = selected.dataset.uk || '';
        document.getElementById('category_en').value = selected.dataset.en || '';
    });

    // Initialize category fields if a value is already selected
    if (categorySelect.value) {
        const selected = categorySelect.options[categorySelect.selectedIndex];
        document.getElementById('category_uk').value = selected.dataset.uk || '';
        document.getElementById('category_en').value = selected.dataset.en || '';
    }

    // Format date helper
    function formatDate(dateStr, lang) {
        if (!dateStr) {
            const now = new Date();
            dateStr = now.toISOString().split('T')[0];
        }

        const date = new Date(dateStr + 'T12:00:00');

        if (lang === 'uk') {
            const months = ['січня', 'лютого', 'березня', 'квітня', 'травня', 'червня',
                           'липня', 'серпня', 'вересня', 'жовтня', 'листопада', 'грудня'];
            return date.getDate() + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
        } else {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();
        }
    }

    // Handle form submission
    form.addEventListener('submit', function(e) {
        // Collect selected tags
        const tagsUk = [];
        const tagsEn = [];
        tagCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                tagsUk.push(checkbox.dataset.uk);
                tagsEn.push(checkbox.dataset.en);
            }
        });
        document.getElementById('tags_uk').value = tagsUk.join(', ');
        document.getElementById('tags_en').value = tagsEn.join(', ');

        // Format dates
        const dateInput = document.getElementById('publishDate').value;
        document.getElementById('date_uk').value = formatDate(dateInput, 'uk');
        document.getElementById('date_en').value = formatDate(dateInput, 'en');

        // Validate category
        if (!document.getElementById('category_uk').value) {
            e.preventDefault();
            alert('Будь ласка, оберіть категорію');
            categorySelect.focus();
            return false;
        }

        // Disable submit button to prevent double submission
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').textContent = 'Збереження...';
    });
});
</script>
{% endblock %}
